# ä»»åŠ¡æ¸…å•ï¼šå¼‚æ­¥å‡çº§æ£€æŸ¥

**è¾“å…¥**: `packages/commission-upgrade-bundle/specs/async-upgrade-check/` ä¸‹çš„è®¾è®¡æ–‡æ¡£
**å‰ç½®**: plan.mdã€spec.mdã€research.mdã€data-model.mdã€contracts/*.mdã€quickstart.md

**æµ‹è¯•ç­–ç•¥**: TDDï¼ˆæµ‹è¯•é©±åŠ¨å¼€å‘ï¼‰ï¼Œå…ˆç¼–å†™æµ‹è¯•ï¼ˆçº¢ï¼‰ï¼Œå†å®ç°ä»£ç ï¼ˆç»¿ï¼‰ï¼Œæœ€åé‡æ„

**ç»„ç»‡æ–¹å¼**: ä»»åŠ¡æŒ‰ç”¨æˆ·æ•…äº‹åˆ†ç»„ï¼Œç¡®ä¿æ¯ä¸ªæ•…äº‹å¯ç‹¬ç«‹å®ç°ä¸éªŒæ”¶ã€‚

## æ ¼å¼ï¼š`[ID] [P?] [Story] æè¿°`

- **[P]**ï¼šå¯å¹¶è¡Œï¼ˆä¸åŒæ–‡ä»¶ã€æ— æœªå®Œæˆä¾èµ–ï¼‰
- **[Story]**ï¼šæ‰€å±ç”¨æˆ·æ•…äº‹ï¼ˆå¦‚ US1/US2/US3ï¼‰
- æè¿°ä¸­å¿…é¡»åŒ…å«å…·ä½“æ–‡ä»¶è·¯å¾„

## è·¯å¾„çº¦å®š

- è·¯å¾„ç›¸å¯¹ Scope æ ¹ï¼š`packages/commission-upgrade-bundle/`
- æºç ï¼š`src/`ï¼Œæµ‹è¯•ï¼š`tests/`ï¼ˆé•œåƒ src/ ç»“æ„ï¼‰
- é…ç½®ï¼š`src/Resources/config/`

---

## Phase 1: åˆå§‹åŒ–ï¼ˆé€šç”¨åŸºç¡€ï¼‰

**ç›®çš„**: åˆå§‹åŒ–é¡¹ç›®ç»“æ„ä¸ä¾èµ–é…ç½®

- [X] T001 éªŒè¯ Symfony Messenger ä¾èµ–æ˜¯å¦å·²å®‰è£…ï¼ˆæ£€æŸ¥æ ¹ composer.jsonï¼‰
- [X] T002 [P] åˆ›å»º Message ç›®å½•ï¼šsrc/Message/
- [X] T003 [P] åˆ›å»º MessageHandler ç›®å½•ï¼šsrc/MessageHandler/
- [X] T004 [P] åˆ›å»ºæµ‹è¯•ç›®å½•é•œåƒï¼štests/Message/, tests/MessageHandler/

---

## Phase 2: åŸºç¡€èƒ½åŠ›ï¼ˆé˜»å¡é¡¹ï¼‰

**ç›®çš„**: æ‰€æœ‰ç”¨æˆ·æ•…äº‹å¼€å§‹å‰å¿…é¡»å®Œæˆçš„èƒ½åŠ›

**âš ï¸ å…³é”®**: æœªå®Œæˆå‰ç¦æ­¢è¿›å…¥ä»»æ„ç”¨æˆ·æ•…äº‹

- [X] T005 ç¡®è®¤ Symfony Messenger é…ç½®ï¼ˆè¯»å–åº”ç”¨å±‚ config/packages/messenger.yamlï¼Œè®°å½•ä¼ è¾“å±‚ç±»å‹ï¼‰
- [X] T006 [P] ç¡®è®¤ AsyncMessageInterface æ¥å£å¯ç”¨ï¼ˆè¯»å– packages/async-contracts/src/AsyncMessageInterface.phpï¼‰
- [X] T007 [P] ç¡®è®¤ç°æœ‰ WithdrawLedgerStatusListener å®ç°ï¼ˆè¯»å– src/EventListener/WithdrawLedgerStatusListener.phpï¼‰
- [X] T008 [P] ç¡®è®¤ç°æœ‰ DistributorUpgradeService å¯å¤ç”¨ï¼ˆè¯»å– src/Service/DistributorUpgradeService.phpï¼‰

**æ£€æŸ¥ç‚¹**: åŸºç¡€ç¡®è®¤å®Œæˆï¼Œå¯å¹¶è¡Œå¼€å±•ç”¨æˆ·æ•…äº‹

---

## Phase 3: ç”¨æˆ·æ•…äº‹ 1 - æç°å®Œæˆåå¼‚æ­¥è§¦å‘å‡çº§æ£€æŸ¥ï¼ˆä¼˜å…ˆçº§ï¼šP1ï¼‰ğŸ¯ MVP

**ç›®æ ‡**: å°†å‡çº§æ£€æŸ¥ä»åŒæ­¥æ”¹ä¸ºå¼‚æ­¥ï¼Œæç°å“åº”æ—¶é—´ä» 500ms é™è‡³ 100ms ä»¥å†…

**ç‹¬ç«‹éªŒè¯**: åˆ›å»ºæç°æµæ°´å¹¶æ ‡è®°ä¸º Completedï¼ŒéªŒè¯æ¶ˆæ¯æŠ•é€’åˆ°é˜Ÿåˆ—ä¸”æç°çŠ¶æ€æ›´æ–°åœ¨ 100ms å†…å®Œæˆ

### æµ‹è¯•ï¼ˆTDDï¼šçº¢â†’ç»¿â†’é‡æ„ï¼‰

> å…ˆç¼–å†™æµ‹è¯•ï¼ŒéªŒè¯å¤±è´¥ï¼ˆçº¢ï¼‰ï¼Œå†å®ç°ä»£ç 

- [X] T009 [P] [US1] å¥‘çº¦æµ‹è¯•ï¼šéªŒè¯ DistributorUpgradeCheckMessage å®ç° AsyncMessageInterface - tests/AsyncMessageInterfaceContractTest.php
- [X] T010 [P] [US1] å•å…ƒæµ‹è¯•ï¼šéªŒè¯ DistributorUpgradeCheckMessage æ¶ˆæ¯åˆ›å»ºä¸åºåˆ—åŒ– - tests/Message/DistributorUpgradeCheckMessageTest.php
- [X] T011 [P] [US1] å•å…ƒæµ‹è¯•ï¼šéªŒè¯ DistributorUpgradeCheckHandler å¤„ç†é€»è¾‘ï¼ˆMock ä¾èµ–ï¼‰- tests/MessageHandler/DistributorUpgradeCheckHandlerTest.php
- [X] T012 [US1] é›†æˆæµ‹è¯•ï¼šéªŒè¯æç°å®Œæˆåæ¶ˆæ¯æŠ•é€’åˆ°é˜Ÿåˆ— - tests/AsyncUpgradeFlowTest.php

### å®ç°

- [X] T013 [P] [US1] åˆ›å»º DistributorUpgradeCheckMessage æ¶ˆæ¯ç±» - src/Message/DistributorUpgradeCheckMessage.phpï¼ˆå®ç° AsyncMessageInterfaceï¼Œreadonly å±æ€§ï¼šdistributorId, triggeringWithdrawLedgerIdï¼‰
- [X] T014 [US1] åˆ›å»º DistributorUpgradeCheckHandler æ¶ˆæ¯å¤„ç†å™¨ - src/MessageHandler/DistributorUpgradeCheckHandler.phpï¼ˆæ³¨å…¥ EntityManagerã€DistributorUpgradeServiceã€Loggerï¼‰
- [X] T015 [US1] ä¿®æ”¹ WithdrawLedgerStatusListener ä¸ºå¼‚æ­¥æŠ•é€’ - src/EventListener/WithdrawLedgerStatusListener.phpï¼ˆæ³¨å…¥ MessageBusInterfaceï¼ŒæŠ•é€’æ¶ˆæ¯è€Œéç›´æ¥è°ƒç”¨æœåŠ¡ï¼‰
- [X] T016 [US1] é…ç½® Messenger routing - src/Resources/config/services.yamlï¼ˆè·¯ç”± DistributorUpgradeCheckMessage åˆ° async ä¼ è¾“å±‚ï¼‰
- [X] T017 [US1] è¿è¡Œæµ‹è¯•éªŒè¯å®ç°ï¼ˆæ‰€æœ‰ US1 æµ‹è¯•é€šè¿‡ï¼‰

**æ£€æŸ¥ç‚¹**: ç”¨æˆ·æ•…äº‹ 1 å¯ç‹¬ç«‹è¿è¡Œä¸æµ‹è¯• - æç°è§¦å‘å¼‚æ­¥å‡çº§æ£€æŸ¥

---

## Phase 4: ç”¨æˆ·æ•…äº‹ 2 - å‡çº§æ£€æŸ¥ä»»åŠ¡å¯é‡è¯•ä¸å¹‚ç­‰æ€§ï¼ˆä¼˜å…ˆçº§ï¼šP1ï¼‰

**ç›®æ ‡**: ç¡®ä¿å‡çº§æ£€æŸ¥ä»»åŠ¡å¤±è´¥å¯é‡è¯•ï¼Œä¸”å¤šæ¬¡æ‰§è¡Œä¸å¯¼è‡´é‡å¤å‡çº§

**ç‹¬ç«‹éªŒè¯**: æ¨¡æ‹Ÿä»»åŠ¡æ‰§è¡Œå¤±è´¥å¹¶éªŒè¯é‡è¯•ï¼›éªŒè¯åŒä¸€åˆ†é”€å‘˜å¤šæ¬¡æ‰§è¡Œå‡çº§æ£€æŸ¥åªäº§ç”Ÿä¸€æ¡å†å²è®°å½•

### æµ‹è¯•ï¼ˆTDDï¼‰

- [X] T018 [P] [US2] é›†æˆæµ‹è¯•ï¼šéªŒè¯ä»»åŠ¡å¤±è´¥åé‡è¯•æœºåˆ¶ - tests/AsyncUpgradeFlowTest.phpï¼ˆæ‰©å±•ï¼šæ¨¡æ‹Ÿæ•°æ®åº“å¼‚å¸¸ï¼ŒéªŒè¯é‡è¯•ï¼‰
- [X] T019 [P] [US2] é›†æˆæµ‹è¯•ï¼šéªŒè¯å¹‚ç­‰æ€§ï¼ˆé‡å¤æ¶ˆæ¯åªå‡çº§ä¸€æ¬¡ï¼‰- tests/IdempotencyTest.php

### å®ç°

- [X] T020 [US2] åœ¨ DistributorUpgradeCheckHandler ä¸­æ·»åŠ é”™è¯¯å¤„ç†é€»è¾‘ï¼ˆåŒºåˆ†å¯é‡è¯•/ä¸å¯é‡è¯•å¼‚å¸¸ï¼‰- src/MessageHandler/DistributorUpgradeCheckHandler.php
- [X] T021 [US2] é…ç½® Messenger é‡è¯•ç­–ç•¥ï¼ˆmax_retries=3, æŒ‡æ•°é€€é¿ï¼‰- src/Resources/config/services.yamlï¼ˆæ‰©å±• messenger é…ç½®ï¼‰
- [X] T022 [US2] é…ç½®æ­»ä¿¡é˜Ÿåˆ—ï¼ˆfailure_transportï¼‰- src/Resources/config/services.yaml
- [X] T023 [US2] æ·»åŠ ç»“æ„åŒ–æ—¥å¿—è®°å½•ï¼ˆæŠ•é€’ã€å¤„ç†ã€æˆåŠŸã€å¤±è´¥ï¼‰- src/MessageHandler/DistributorUpgradeCheckHandler.phpï¼ˆæ‰©å±•æ—¥å¿—ï¼‰
- [X] T024 [US2] è¿è¡Œæµ‹è¯•éªŒè¯å¹‚ç­‰æ€§ä¸é‡è¯•ï¼ˆæ‰€æœ‰ US2 æµ‹è¯•é€šè¿‡ï¼‰

**æ£€æŸ¥ç‚¹**: ç”¨æˆ·æ•…äº‹ 1ã€2 å‡å¯ç‹¬ç«‹è¿è¡Œ - å¼‚æ­¥å‡çº§æ£€æŸ¥ + å¯é æ€§ä¿éšœ

---

## Phase 5: ç”¨æˆ·æ•…äº‹ 3 - æ”¯æŒæ‰¹é‡è§¦å‘å‡çº§æ£€æŸ¥ï¼ˆä¼˜å…ˆçº§ï¼šP2ï¼‰

**ç›®æ ‡**: æä¾›å‘½ä»¤è¡Œå·¥å…·æ‰¹é‡è§¦å‘å‡çº§æ£€æŸ¥ï¼Œå‘½ä»¤åœ¨ 5 ç§’å†…è¿”å›

**ç‹¬ç«‹éªŒè¯**: é€šè¿‡å‘½ä»¤è¡Œè§¦å‘ 1000 ä¸ªåˆ†é”€å‘˜å‡çº§æ£€æŸ¥ï¼ŒéªŒè¯å‘½ä»¤å¿«é€Ÿè¿”å›ä¸”æ‰€æœ‰æ¶ˆæ¯æŠ•é€’åˆ°é˜Ÿåˆ—

### æµ‹è¯•ï¼ˆTDDï¼‰

- [X] T025 [P] [US3] åŠŸèƒ½æµ‹è¯•ï¼šéªŒè¯æ‰¹é‡å‘½ä»¤æŠ•é€’æ¶ˆæ¯åˆ°é˜Ÿåˆ— - tests/Command/BatchCheckUpgradeCommandTest.phpï¼ˆæµ‹è¯•é•œåƒ src/Command/ï¼‰
- [X] T026 [US3] é›†æˆæµ‹è¯•ï¼šéªŒè¯æ‰¹é‡æ¶ˆæ¯æ¶ˆè´¹å®Œæˆå‡çº§ - tests/AsyncUpgradeFlowTest.phpï¼ˆæ‰©å±•ï¼šæ‰¹é‡åœºæ™¯ï¼‰

### å®ç°

- [X] T027 [US3] åˆ›å»ºæµ‹è¯•ç›®å½•ï¼štests/Command/
- [X] T028 [US3] åˆ›å»º BatchCheckUpgradeCommand å‘½ä»¤ç±» - src/Command/BatchCheckUpgradeCommand.phpï¼ˆæ”¯æŒ --levelã€--limit å‚æ•°ï¼Œæ‰¹é‡æŠ•é€’æ¶ˆæ¯ï¼‰
- [X] T029 [US3] åœ¨ Command ä¸­æ³¨å…¥ MessageBusInterface å’Œ EntityManager
- [X] T030 [US3] å®ç°æ‰¹é‡æŸ¥è¯¢åˆ†é”€å‘˜é€»è¾‘ï¼ˆåˆ†é¡µï¼Œé¿å…å†…å­˜æº¢å‡ºï¼‰
- [X] T031 [US3] å®ç°æ‰¹é‡æŠ•é€’æ¶ˆæ¯é€»è¾‘ï¼ˆæ‰¹æ¬¡æäº¤ï¼Œæ€§èƒ½ä¼˜åŒ–ï¼‰
- [X] T032 [US3] æ·»åŠ é‡å¤è¯·æ±‚æ£€æµ‹ï¼ˆç®€å•é˜²æŠ–ï¼šè®°å½•æœ€è¿‘æ‰§è¡Œæ—¶é—´åˆ°æ—¥å¿—ï¼‰
- [X] T033 [US3] è¿è¡Œæµ‹è¯•éªŒè¯æ‰¹é‡å‘½ä»¤ï¼ˆæ‰€æœ‰ US3 æµ‹è¯•é€šè¿‡ï¼‰

**æ£€æŸ¥ç‚¹**: æ‰€æœ‰ç›®æ ‡æ•…äº‹å‡å¯ç‹¬ç«‹è¿è¡Œ - å®Œæ•´å¼‚æ­¥å‡çº§æ£€æŸ¥ + æ‰¹é‡èƒ½åŠ›

---

## Phase 6: æ‰“ç£¨ä¸è·¨é¢†åŸŸ

**ç›®çš„**: è´¨é‡ä¿éšœã€æ–‡æ¡£å®Œå–„ã€æ€§èƒ½éªŒè¯

- [X] T034 [P] è¿è¡Œ PHPStan level 8 é™æ€åˆ†æï¼ˆpackages/commission-upgrade-bundle/src/ï¼‰
- [X] T035 [P] è¿è¡Œ PHP-CS-Fixer æ ¼å¼åŒ–æ£€æŸ¥ï¼ˆpackages/commission-upgrade-bundle/src/ï¼‰
- [X] T036 [P] éªŒè¯æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ˆ./vendor/bin/phpunit packages/commission-upgrade-bundle/tests/ï¼‰
- [X] T037 è¿è¡Œ quickstart.md éªŒè¯ï¼ˆæ‰‹åŠ¨éªŒè¯ï¼šåˆ›å»ºæç°æµæ°´ã€å¯åŠ¨ Workerã€æ£€æŸ¥å‡çº§ç»“æœï¼‰
- [X] T038 [P] æ›´æ–° Bundle README.mdï¼ˆæ·»åŠ å¼‚æ­¥å‡çº§æ£€æŸ¥ä½¿ç”¨è¯´æ˜ï¼‰
- [ ] T039 æ€§èƒ½éªŒè¯ï¼šå‹æµ‹æç°æ¥å£ï¼ŒéªŒè¯å“åº”æ—¶é—´ < 100msï¼ˆP95ï¼‰
- [ ] T040 æ€§èƒ½éªŒè¯ï¼šæ‰¹é‡æŠ•é€’ 1000 æ¡æ¶ˆæ¯ï¼ŒéªŒè¯å‘½ä»¤è¿”å›æ—¶é—´ < 5 ç§’
- [ ] T041 ç›‘æ§éªŒè¯ï¼šç¡®è®¤æ—¥å¿—ç»“æ„åŒ–è¾“å‡ºï¼ˆJSON æ ¼å¼ï¼‰ä¸”åŒ…å«å…³é”®å­—æ®µ

---

## ä¾èµ–ä¸æ‰§è¡Œé¡ºåº

### é˜¶æ®µä¾èµ–
- Phase 1 â†’ Phase 2 â†’ Phase 3/4/5ï¼ˆå¯å¹¶è¡Œï¼Œä¼˜å…ˆ P1ï¼‰â†’ Phase 6
- Phase 3ã€4ã€5 ä¹‹é—´æ— å¼ºä¾èµ–ï¼Œä½†å»ºè®®æŒ‰ä¼˜å…ˆçº§é¡ºåºæ‰§è¡Œï¼ˆP1 å…ˆäº P2ï¼‰

### æ•…äº‹å†…ä¾èµ–
- **US1**ï¼šT009-T012ï¼ˆæµ‹è¯•ï¼‰â†’ T013-T016ï¼ˆå®ç°ï¼‰â†’ T017ï¼ˆéªŒè¯ï¼‰
- **US2**ï¼šT018-T019ï¼ˆæµ‹è¯•ï¼‰â†’ T020-T023ï¼ˆå®ç°ï¼‰â†’ T024ï¼ˆéªŒè¯ï¼‰
- **US3**ï¼šT025-T026ï¼ˆæµ‹è¯•ï¼‰â†’ T027-T032ï¼ˆå®ç°ï¼‰â†’ T033ï¼ˆéªŒè¯ï¼‰

### å¹¶è¡Œæ‰§è¡Œæœºä¼š
- Phase 1: T002-T004 å¯å¹¶è¡Œ
- Phase 2: T006-T008 å¯å¹¶è¡Œ
- US1 æµ‹è¯•: T009-T012 å¯å¹¶è¡Œï¼ˆä¸åŒæµ‹è¯•æ–‡ä»¶ï¼‰
- US1 å®ç°: T013 å¯ä¸ T014 å¹¶è¡Œï¼ˆä¸åŒæ–‡ä»¶ï¼‰
- US2 æµ‹è¯•: T018-T019 å¯å¹¶è¡Œ
- US2 å®ç°: T020ã€T023 å¯å¹¶è¡Œï¼ˆä¿®æ”¹ä¸åŒéƒ¨åˆ†ï¼‰
- US3 æµ‹è¯•: T025-T026 å¯å¹¶è¡Œ
- Phase 6: T034-T036ã€T038 å¯å¹¶è¡Œ

---

## å®æ–½ç­–ç•¥

### MVP èŒƒå›´ï¼ˆæœ€å°å¯è¡Œäº§å“ï¼‰
- **Phase 1-2**ï¼šåŸºç¡€è®¾æ–½
- **Phase 3ï¼ˆUS1ï¼‰**ï¼šå¼‚æ­¥è§¦å‘å‡çº§æ£€æŸ¥ï¼ˆæ ¸å¿ƒä»·å€¼ï¼‰
- éªŒè¯ MVP åå†è¿›å…¥ US2ã€US3

### å¢é‡äº¤ä»˜
1. **ç¬¬ä¸€è½®**ï¼šUS1ï¼ˆå¼‚æ­¥åŒ–ï¼‰â†’ éªŒè¯æ€§èƒ½æå‡
2. **ç¬¬äºŒè½®**ï¼šUS2ï¼ˆå¯é æ€§ï¼‰â†’ éªŒè¯é‡è¯•ä¸å¹‚ç­‰æ€§
3. **ç¬¬ä¸‰è½®**ï¼šUS3ï¼ˆæ‰¹é‡ï¼‰â†’ éªŒè¯è¿è¥å·¥å…·

### è´¨é‡é—¨ç¦
- æ¯ä¸ªç”¨æˆ·æ•…äº‹å®Œæˆåè¿è¡Œå¯¹åº”æµ‹è¯•
- Phase 6 å‰è¿è¡Œå…¨é‡æµ‹è¯•ï¼ˆPHPStan + PHPUnitï¼‰
- æ‰€æœ‰è´¨é‡é—¨ç¦é€šè¿‡åæ‰å¯æäº¤ä»£ç 

---

## ä»»åŠ¡ç»Ÿè®¡

- **æ€»ä»»åŠ¡æ•°**: 41
- **US1 ä»»åŠ¡æ•°**: 9ï¼ˆæµ‹è¯• 4 + å®ç° 5ï¼‰
- **US2 ä»»åŠ¡æ•°**: 7ï¼ˆæµ‹è¯• 2 + å®ç° 5ï¼‰
- **US3 ä»»åŠ¡æ•°**: 9ï¼ˆæµ‹è¯• 2 + å®ç° 7ï¼‰
- **å¹¶è¡Œæœºä¼š**: 18 ä¸ªä»»åŠ¡æ ‡è®° [P]

---

## æ ¼å¼éªŒè¯

âœ… æ‰€æœ‰ä»»åŠ¡éµå¾ª `- [ ] [ID] [P?] [Story?] æè¿° - æ–‡ä»¶è·¯å¾„` æ ¼å¼
âœ… ä»»åŠ¡æŒ‰ç”¨æˆ·æ•…äº‹åˆ†ç»„ï¼Œæ¯ä¸ªæ•…äº‹å¯ç‹¬ç«‹éªŒè¯
âœ… æµ‹è¯•ä»»åŠ¡åœ¨å®ç°ä»»åŠ¡ä¹‹å‰ï¼ˆTDD æµç¨‹ï¼‰
âœ… æ–‡ä»¶è·¯å¾„æ˜ç¡®ï¼Œä¾¿äºæ‰§è¡Œ
âœ… ä¾èµ–å…³ç³»æ¸…æ™°ï¼Œæ”¯æŒå¹¶è¡Œä¸å¢é‡äº¤ä»˜
