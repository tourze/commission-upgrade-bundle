# 功能规格说明书：分销员自动升级

**Feature**: `distributor-auto-upgrade`
**Scope**: `packages/commission-upgrade-bundle`
**创建日期**: 2025-11-17
**状态**: Draft
**输入**: 用户描述 "分销员的升级，能按照业绩总金额进行自动升级；例如：5000已结算的佣金就从第一级升到第二级；10000已结算的佣金就从第二级升到第三级；具体的已结算的佣金数待定，但是后台能做到配置等级升级的业绩数量。【以订单还是以业绩提现为统计规则，规避有人恶意刷单来提升自己的等级】"

## Clarifications

### Session 2025-11-17

- Q: 佣金何时从"待结算"变为"已结算"？ → A: 分销员提现成功后（WithdrawLedger状态为Completed）标记为已结算
- Q: 提现功能在哪里实现？ → A: 提现功能已在 OrderCommissionBundle 实现，CommissionUpgradeBundle 仅负责监听提现成功事件并执行升级逻辑
- Q: 实体如何复用？ → A: 复用 OrderCommissionBundle 的 Distributor、DistributorLevel、WithdrawLedger 实体；升级阈值配置存储在 DistributorLevel.criteriaJson 中
- Q: 升级条件应该支持什么程度的灵活性？ → A: 采用第三方规则引擎（Symfony Expression Language），支持复杂的组合条件（如"withdrawnAmount > 5000 and inviteeCount > 10"）
- Q: 后台管理员如何编辑升级条件表达式？ → A: 混合方案（基于 EasyAdmin bundle）：简单场景用表单 UI，提供"高级模式"切换到代码编辑器（Monaco Editor + 语法高亮）

## 用户场景与测试（必填）

<!--
  重要：用户故事按重要性排序，并保持“独立可测试”：
  - 只实现其中一个故事，也能形成可演示的 MVP
  - 每个故事可独立开发、测试、发布
  给每个故事标注优先级（P1/P2/P3）。
-->

### 用户故事 1 - 分销员达标自动升级（优先级：P1）

当分销员的已结算佣金累计达到升级阈值时，系统自动将其等级提升到下一级别，无需人工干预。

**优先级原因**： 这是核心业务价值，直接影响分销员激励机制和业务增长。自动化升级减少运营成本，提高分销员满意度。

**独立验证方式**： 创建测试分销员，模拟佣金结算流程，当累计已结算佣金达到配置的阈值（如5000元）时，验证系统自动将等级从1级升至2级，并记录升级事件。

**验收场景**：

1. **Given** 分销员当前为1级，累计已结算佣金4800元，升级阈值配置为5000元，**When** 分销员申请并成功提现300元佣金，**Then** 系统自动将分销员升级为2级，累计已结算佣金更新为5100元
2. **Given** 分销员当前为2级，累计已结算佣金9500元，升级阈值配置为10000元（2级→3级），**When** 分销员申请并成功提现600元佣金，**Then** 系统自动将分销员升级为3级
3. **Given** 分销员当前为3级，已达到最高等级，**When** 分销员成功提现任意金额佣金，**Then** 分销员等级保持3级不变
4. **Given** 分销员有待提现佣金5000元（订单已完成但未提现），**When** 升级阈值为5000元，**Then** 分销员保持1级不变（仅提现成功后才计入）
5. **Given** 分销员申请提现1000元但提现失败（WithdrawLedger.Failed），**When** 提现失败，**Then** 该笔佣金不计入已提现金额，分销员等级不变

---

### 用户故事 2 - 后台配置升级规则（优先级：P1）

管理员可在后台（EasyAdmin）配置每个等级的升级条件表达式，支持简单条件（如"提现金额 > 5000"）和复杂组合条件（如"提现金额 > 5000 AND 邀请人数 > 10"），存储在 DistributorLevel.criteriaJson 中，灵活调整分销激励策略。

**优先级原因**： 配置能力是业务灵活性的基础，不同阶段的运营策略可能需要调整升级门槛。支持复杂条件可以设计更精准的激励机制。

**独立验证方式**： 管理员登录 EasyAdmin 后台，访问分销员等级配置页面，使用表单 UI 或高级模式（代码编辑器）设置升级条件表达式并保存到 DistributorLevel.criteriaJson，验证配置生效后新提现成功的佣金按新规则触发升级。

**验收场景**：

1. **Given** 管理员已登录 EasyAdmin 后台，**When** 进入分销员等级配置页面，使用表单 UI 设置1级→2级条件为"提现金额 > 5000"，2级→3级条件为"提现金额 > 10000"，并保存，**Then** 系统将表达式保存到 criteriaJson，后续升级判断使用新条件
2. **Given** 管理员需要设置复杂条件，**When** 切换到"高级模式"，输入表达式 "withdrawnAmount > 5000 and inviteeCount > 10"，并保存，**Then** 系统验证表达式语法正确后保存，分销员需同时满足提现金额和邀请人数才能升级
3. **Given** 管理员设置升级条件，**When** 输入无效的表达式（如语法错误、引用不存在的变量），**Then** 系统提示错误信息（指出错误位置），不允许保存
4. **Given** 管理员使用表单 UI 配置简单条件，**When** 选择"提现金额"字段，输入比较符">="，输入值"5000"，**Then** 系统自动生成表达式 "withdrawnAmount >= 5000" 并保存

---

### 用户故事 3 - 防刷单机制保障（优先级：P2）

系统仅统计已提现成功的佣金作为升级依据，排除待提现或提现失败的订单，防止恶意刷单提升等级。

**优先级原因**： 保障升级机制的公平性和业务安全，防止利益损失。通过要求实际提现成功来防范刷单行为。

**独立验证方式**： 创建测试分销员，生成包含待提现、已提现、提现失败等不同状态的佣金记录，验证系统仅累计"已提现成功"状态的佣金金额用于升级判断。

**验收场景**：

1. **Given** 分销员有待提现佣金3000元（订单已完成）、已提现成功佣金4000元，升级阈值5000元，**When** 系统执行升级检查，**Then** 仅统计已提现成功的4000元，分销员保持1级
2. **Given** 分销员有已提现成功佣金4500元，**When** 申请提现600元并成功（累计5100元），**Then** 系统升级分销员至2级
3. **Given** 分销员通过异常订单快速生成大量待提现佣金（订单已完成但未提现），**When** 这些佣金未实际提现，**Then** 分销员等级不变，无法通过刷单升级
4. **Given** 分销员申请提现1000元但提现失败（如银行卡信息错误），**When** 提现失败后，**Then** 该笔佣金不计入已结算金额，分销员等级不变

---

### 用户故事 4 - 升级历史记录与通知（优先级：P3）

系统记录每次升级事件（时间、原等级、新等级、触发佣金金额），并向分销员发送升级通知。

**优先级原因**： 增强用户体验和运营透明度，但非核心功能，可后期优化。

**独立验证方式**： 触发分销员升级后，查询升级历史记录表，验证记录包含完整信息；检查分销员是否收到升级通知（站内信/短信/邮件）。

**验收场景**：

1. **Given** 分销员从1级升至2级，**When** 升级完成，**Then** 系统记录升级事件（时间、1→2级、累计佣金5100元），并发送通知"恭喜您升至2级分销员"
2. **Given** 管理员查询某分销员升级历史，**When** 访问升级记录页面，**Then** 显示所有历史升级事件的时间线
3. **Given** 分销员已达最高等级，**When** 继续结算佣金，**Then** 不记录升级事件，不发送升级通知

---

### 边界/异常场景

- **等级配置缺失**：当某等级的升级阈值未配置时，系统如何处理？
  - 默认行为：该等级无法升级，保持当前等级
  - 管理员应收到配置缺失的警告提示

- **并发佣金结算**：多笔佣金同时结算导致升级条件同时满足时如何处理？
  - 系统应确保升级操作幂等性，避免重复升级或跳级
  - 升级检查应基于最终累计金额，而非单次结算金额

- **提现失败处理**：分销员申请提现但失败（如银行卡信息错误、余额不足），该笔佣金如何处理？
  - 默认行为：提现失败后佣金恢复为"待提现"状态，不计入已结算金额
  - 分销员可重新发起提现申请

- **佣金退款后降级**：已提现成功的佣金因订单退款需要追回，是否触发降级？
  - 默认行为：不支持降级（行业标准做法）
  - 如需降级功能，需额外设计降级规则和追款机制

- **跨等级升级**：累计佣金一次性满足多级升级条件时如何处理？
  - 示例：1级分销员累计已结算佣金达到15000元（超过2级阈值10000元）
  - 系统应逐级升级（1→2→3），而非跳级

- **历史数据迁移**：系统上线前已有分销员和佣金数据，如何初始化等级？
  - 需提供批量计算工具，基于历史已结算佣金自动计算并设置初始等级

- **升级条件表达式错误**：管理员配置的表达式存在语法错误或运行时错误（如除零、类型不匹配），如何处理？
  - 保存时校验：系统必须在保存前验证表达式语法，拒绝无效表达式
  - 运行时容错：升级检查时如果表达式执行失败，记录错误日志，分销员等级不变，通知管理员修复配置

- **表达式引用的变量缺失**：表达式中引用的变量（如 inviteeCount）在系统中未实现或数据缺失，如何处理？
  - 设计时明确可用变量清单（如 withdrawnAmount, inviteeCount, orderCount 等）
  - 保存时验证表达式仅引用支持的变量
  - 运行时若数据缺失，使用默认值（如 0）或视为条件不满足

## 需求（必填）

### 功能需求

- **FR-001**：系统必须监听 WithdrawLedger 状态变为 Completed 的事件，并自动检查分销员是否满足升级条件
- **FR-002**：系统必须计算分销员的升级判断所需的上下文变量（如 withdrawnAmount: 累计已提现成功佣金、inviteeCount: 邀请人数、orderCount: 订单数等）
- **FR-003**：系统必须使用 Symfony Expression Language 从 DistributorLevel.criteriaJson 读取并执行升级条件表达式，支持复杂的组合条件（AND、OR、比较运算符等）
- **FR-004**：管理员必须能够在 EasyAdmin 后台编辑 DistributorLevel.criteriaJson 配置升级条件表达式
- **FR-005**：EasyAdmin 后台必须提供两种编辑模式：表单 UI（简单条件）和高级模式（代码编辑器，支持 Monaco Editor + 语法高亮）
- **FR-006**：系统必须在保存升级条件表达式前验证其语法有效性和变量合法性（仅允许引用支持的变量），拒绝无效表达式
- **FR-007**：系统必须提供可用变量清单（如 withdrawnAmount, inviteeCount, orderCount），供管理员在表达式中引用
- **FR-008**：管理员修改 DistributorLevel.criteriaJson 后必须立即生效，后续升级判断使用新配置
- **FR-009**：系统必须支持多级等级体系（复用OrderCommissionBundle的DistributorLevel，至少3级，可扩展）
- **FR-010**：系统必须确保升级操作的原子性，避免并发冲突导致的数据不一致
- **FR-011**：系统必须创建新实体记录每次升级事件的完整信息（时间、原等级、新等级、满足的条件表达式、分销员ID、触发的WithdrawLedger ID）
- **FR-012**：系统必须在分销员达到最高等级后，不再执行升级检查
- **FR-013**：系统必须支持查询分销员的升级历史记录
- **FR-014**：系统必须在升级成功后通过站内信向分销员发送通知
- **FR-015**：系统必须提供批量计算工具，用于历史数据迁移时基于 WithdrawLedger 历史数据初始化分销员等级
- **FR-016**：系统必须在升级条件表达式执行失败时记录详细错误日志（包含表达式内容、上下文变量、错误原因），通知管理员修复配置

### 核心实体（若涉及数据）

**复用 OrderCommissionBundle 实体**：

- **Distributor**（分销员）：复用 `Tourze\OrderCommissionBundle\Entity\Distributor`，包含 level (DistributorLevel) 属性
- **DistributorLevel**（分销员等级）：复用 `Tourze\OrderCommissionBundle\Entity\DistributorLevel`，使用其 `criteriaJson` 字段存储升级条件表达式配置
  - 结构示例（简单条件）：`{"upgradeExpression": "withdrawnAmount > 5000"}`
  - 结构示例（复杂条件）：`{"upgradeExpression": "withdrawnAmount > 5000 and inviteeCount > 10"}`
  - 可用变量：withdrawnAmount（已提现金额）, inviteeCount（邀请人数）, orderCount（订单数）等
- **WithdrawLedger**（提现流水）：复用 `Tourze\OrderCommissionBundle\Entity\WithdrawLedger`，通过查询 `status=Completed` 的记录计算已提现成功佣金总额

**新建实体**（仅限 CommissionUpgradeBundle）：

- **DistributorLevelUpgradeHistory**（升级历史）：记录每次升级事件的完整信息
  - 时间：upgradeTime
  - 原等级：previousLevel (关联 DistributorLevel)
  - 新等级：newLevel (关联 DistributorLevel)
  - 满足的条件表达式：satisfiedExpression (字符串，记录触发升级的表达式，如 "withdrawnAmount > 5000 and inviteeCount > 10")
  - 升级判断上下文快照：contextSnapshot (JSON，记录当时的变量值，如 `{"withdrawnAmount": 5100, "inviteeCount": 12}`)
  - 所属分销员：distributor (关联 Distributor)
  - 触发的提现流水：triggeringWithdrawLedger (关联 WithdrawLedger，可选)

## 成功标准（必填）

### 可度量结果

- **SC-001**：管理员可在5分钟内完成升级条件配置（通过 EasyAdmin 表单 UI 或高级模式），配置保存后立即生效
- **SC-002**：系统必须在保存时验证升级条件表达式，拒绝100%的无效表达式（语法错误或变量非法）
- **SC-003**：分销员提现成功后（WithdrawLedger.Completed事件），系统在10秒内完成升级条件评估并执行升级（如满足条件）
- **SC-004**：系统支持至少1000名分销员同时触发升级检查（并发 WithdrawLedger.Completed 事件），无性能下降
- **SC-005**：升级操作准确率达到100%（无错误升级、漏升级或数据不一致）
- **SC-006**：防刷单机制有效运行，仅统计 WithdrawLedger.Completed 状态的佣金，准确率100%
- **SC-007**：90%的管理员能在首次使用时无培训完成简单条件配置（通过表单 UI）
- **SC-008**：升级历史记录完整性达到100%，所有升级事件均可追溯，包含满足的条件表达式和上下文快照

### 定性结果

- 分销员对自动升级机制的满意度提升，减少人工升级申请工单
- 运营团队工作效率提升，无需人工审核和执行升级操作
- 业务灵活性增强，支持复杂的升级条件组合，可根据业务策略灵活调整（如"高业绩 OR 高活跃度"）
- 可扩展性强，基于 Symfony Expression Language，未来可轻松新增变量（如团队业绩、复购率等）
- 易用性良好，提供表单 UI（简单场景）和代码编辑器（复杂场景），适配不同管理员需求
- 业务安全性增强，刷单行为无法绕过提现成功的统计规则（复用 OrderCommissionBundle 的提现流程）
- 与 OrderCommissionBundle 集成良好，复用现有实体，减少维护成本
