# 功能规格说明书：后台手动升级检测与执行

**Feature**: `manual-upgrade-check`
**Scope**: `packages/commission-upgrade-bundle`
**创建日期**: 2025-11-19
**状态**: Draft
**输入**: 用户描述 "除了自动升级，我们还需要在后台提供一个能力，输入用户标志,然后主动检测一次是否满足升级条件（按钮1），然后升级（按钮2）"

## 用户场景与测试(必填)

### 用户故事 1 - 查询用户并检测升级条件（优先级：P1）

运营人员在后台管理界面输入用户ID，点击"检测升级条件"按钮,系统立即分析该用户当前状态并返回升级检测结果，显示用户是否满足升级条件、当前等级、目标等级以及具体满足/不满足的条件明细。

**优先级原因**：这是手动升级流程的基础能力，必须先能查询和检测用户状态，才能进行后续升级操作。能独立为运营提供用户升级状态查询价值。

**独立验证方式**：运营人员输入用户ID并点击检测按钮后，能看到该用户的完整升级检测报告，包括当前等级、是否满足升级条件、各项条件的具体数值等信息。

**验收场景**：

1. **Given** 运营人员已登录后台管理系统，**When** 输入有效的用户ID并点击"检测升级条件"按钮，**Then** 系统显示该用户的当前等级、是否满足升级条件、目标等级以及各升级条件的详细数据（如累计消费金额、订单数量、活跃天数等）

2. **Given** 运营人员已登录后台管理系统，**When** 输入的用户ID不存在或格式错误，**Then** 系统显示清晰的错误提示信息，说明用户未找到或输入格式不正确

3. **Given** 运营人员检测了一个不满足升级条件的用户，**When** 查看检测结果，**Then** 系统明确指出哪些条件未满足，并显示当前值与目标值的差距

4. **Given** 运营人员检测了一个满足升级条件的用户，**When** 查看检测结果，**Then** 系统显示所有条件均已满足，并提示可以执行升级操作

---

### 用户故事 2 - 执行手动升级（优先级：P1）

在检测到用户满足升级条件后，运营人员点击"执行升级"按钮，系统立即为该用户执行等级升级操作，并提供升级结果反馈（成功或失败原因）。升级完成后，用户的新等级立即生效，用户可享受新等级对应的权益。

**优先级原因**：这是核心业务价值所在，手动升级的最终目的就是为符合条件的用户提升等级。与故事1组合即可形成完整的MVP。

**独立验证方式**：运营人员对检测结果为"满足条件"的用户点击"执行升级"按钮后，能看到升级成功的确认信息，且再次检测该用户时显示为新的等级。

**验收场景**：

1. **Given** 用户检测结果显示满足升级条件，**When** 运营人员点击"执行升级"按钮，**Then** 系统执行升级操作并显示升级成功确认，包括升级前后的等级信息和升级时间

2. **Given** 用户检测结果显示不满足升级条件，**When** 运营人员点击"执行升级"按钮，**Then** 系统拒绝操作并提示"该用户不满足升级条件，无法执行升级"

3. **Given** 运营人员正在执行升级操作，**When** 升级过程中发生错误（如数据库连接失败），**Then** 系统显示具体错误信息，且用户等级保持原状不变

4. **Given** 用户已经是最高等级，**When** 运营人员尝试执行升级，**Then** 系统提示"该用户已是最高等级，无需升级"

---

### 用户故事 3 - 批量查询用户列表（优先级：P2）

运营人员可以输入多个用户ID（用逗号、空格或换行分隔），系统批量检测并展示列表形式的结果，每行显示一个用户的基本信息和检测结果摘要，支持对列表中满足条件的用户进行批量或单个升级操作。

**优先级原因**：提升运营效率，避免逐个输入用户进行检测。属于体验优化，非MVP必需。

**独立验证方式**：运营人员一次性输入10个用户ID，系统返回10行结果列表，每行包含用户ID、当前等级、是否满足升级条件、快捷操作按钮。

**验收场景**：

1. **Given** 运营人员输入了5个用户ID（逗号分隔），**When** 点击"批量检测"按钮，**Then** 系统返回5行结果，每行显示用户ID、当前等级、目标等级、是否满足条件、操作按钮

2. **Given** 批量检测结果中有3个用户满足条件，**When** 运营人员勾选这3个用户并点击"批量升级"，**Then** 系统为这3个用户执行升级并分别显示成功或失败的结果

3. **Given** 批量输入的用户列表中包含无效的用户ID，**When** 执行批量检测，**Then** 系统对有效用户返回检测结果，对无效ID在对应行显示"用户不存在"

---

### 用户故事 4 - 升级操作日志记录（优先级：P2）

系统自动记录每次手动检测和升级操作的日志，包括操作人、操作时间、目标用户、操作类型（检测/升级）、操作结果等信息。运营人员和管理员可以查询和审计历史操作记录。

**优先级原因**：确保操作可追溯和审计，满足合规要求。但不影响核心功能使用，可后续补充。

**独立验证方式**：运营人员在操作日志页面可以查看到过去所有手动检测和升级的记录，包含完整的操作上下文信息。

**验收场景**：

1. **Given** 运营人员执行了一次手动升级操作，**When** 打开操作日志页面，**Then** 最新记录显示该操作的时间、操作人、目标用户、操作结果

2. **Given** 管理员需要审计某个运营人员的操作，**When** 按操作人筛选日志，**Then** 系统显示该人员的所有历史操作记录

3. **Given** 系统执行了升级操作但失败，**When** 查看日志记录，**Then** 日志中包含详细的失败原因和错误堆栈信息

---

### 边界/异常场景

- **并发冲突**：当某用户正在被手动升级时，同一时间自动升级任务也触发了该用户的升级，如何处理？（建议：通过锁机制或事务保证幂等性，避免重复升级）

- **权限控制**：是否所有后台用户都能执行手动升级？（建议：需要特定权限或角色才能执行升级操作，检测功能可开放给更多角色）

- **用户标识类型**：系统仅支持通过用户ID进行查询和检测，不支持手机号、邮箱等其他标识类型。运营人员需要先通过其他系统或功能获取用户ID后再使用本功能。

- **升级条件变更**：如果升级规则在检测和执行之间发生了变化，如何处理？（建议：执行升级时重新验证条件，确保数据一致性）

- **降级场景**：本功能是否支持手动降级用户等级？（假设：当前仅支持升级，不支持降级；如需降级需使用其他工具或流程）

## 需求（必填）

### 功能需求

- **FR-001**：系统必须提供后台管理界面，允许运营人员输入用户ID并触发升级条件检测

- **FR-002**：系统必须支持通过用户ID查询用户并返回检测结果

- **FR-003**：系统必须在检测结果中显示用户当前等级、目标等级、是否满足升级条件以及各条件的详细数据

- **FR-004**：系统必须提供"执行升级"功能，允许运营人员为满足条件的用户手动触发等级升级

- **FR-005**：系统必须在执行升级前再次验证用户是否满足条件，防止数据不一致

- **FR-006**：系统必须为升级操作提供明确的成功或失败反馈，失败时需显示具体原因

- **FR-007**：系统必须记录所有手动检测和升级操作的日志，包括操作人、操作时间、目标用户、操作结果等信息

- **FR-008**：系统必须对手动升级功能实施权限控制，只有授权角色才能执行升级操作

- **FR-009**：系统必须处理无效用户ID的情况，并返回清晰的错误提示

- **FR-010**：系统必须确保手动升级与自动升级之间不会产生冲突或重复升级

### 核心实体（若涉及数据）

- **用户**：被检测和升级的目标对象，包含用户ID、当前等级、升级相关的业务数据（消费金额、订单数、活跃度等）

- **等级**：用户所属的会员等级，包含等级名称、等级顺序、升级条件定义

- **升级条件**：触发等级升级的规则，包含条件类型（消费金额、订单数等）、阈值、计算周期等

- **升级记录**：记录每次升级操作的详细信息，包含用户、升级前等级、升级后等级、升级时间、触发方式（自动/手动）、操作人等

- **操作日志**：记录手动检测和升级的操作审计信息，包含操作类型、操作人、操作时间、目标用户、操作结果等

## 成功标准（必填）

### 可度量结果

- **SC-001**：运营人员可在5秒内完成用户ID输入并获得升级条件检测结果

- **SC-002**：检测结果准确率达到100%，即检测结果与实际升级规则完全一致

- **SC-003**：单个用户的手动升级操作可在3秒内完成（含条件验证和数据更新）

- **SC-004**：系统能支撑至少5个运营人员同时进行手动检测和升级操作，无性能下降

- **SC-005**：所有手动升级操作均被完整记录，日志可查询率达到100%

- **SC-006**：运营人员首次使用该功能时，无需培训即可在10分钟内完成首次检测和升级操作

- **SC-007**：手动升级功能上线后，因用户投诉"符合条件但未自动升级"而产生的人工处理工单减少80%

### 约束与假设

**假设**：

- 系统已存在自动升级功能和相应的升级规则引擎
- 用户数据和升级条件数据已在系统中维护
- 后台管理系统已有基础的用户权限和认证机制
- 运营人员具备基本的后台系统操作能力

**约束**：

- 手动升级必须遵循与自动升级相同的业务规则和数据一致性要求
- 升级操作不可逆，执行后无法通过本功能进行回退
- 操作日志必须持久化存储至少6个月以满足审计要求
